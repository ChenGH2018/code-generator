<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="${mapperPath}">

    <!--表名 -->
    <sql id="tableName">
        ${tableName}
    </sql>

    <sql id="field">
        id,
        <#list importPackages as package>
        import ${package};
        </#list>
    </sql>

    <resultMap id="BaseResultMap" type="SetMeal">
        <id column="id" property="id"/>
        <result column="add_user" property="addUser"/>
        <result column="add_time" property="addTime"/>
        <result column="update_user" property="updateUser"/>
        <result column="update_time" property="updateTime"/>
        <result column="catering_time" property="cateringTime"/>
        <result column="catering_period" property="cateringPeriod"/>
        <result column="a_menu" property="aMenu"/>
        <result column="a_menu_price" property="aMenuPrice"/>
        <result column="b_menu" property="bMenu"/>
        <result column="b_menu_price" property="bMenuPrice"/>
        <result column="soup" property="soup"/>
        <result column="stew_ids" property="stewIds"/>
        <result column="dessert_ids" property="dessertIds"/>
        <result column="is_reservation" property="isReservation"/>
        <result column="is_delete" property="isDelete"/>
        <result column="carrying_type" property="carryingType"/>
        <result column="photo_url" property="photoUrl"/>
        <result column="note" property="note"/>
        <result column="a_menu_id" property="aMenuId"/>
        <result column="b_menu_id" property="bMenuId"/>
    </resultMap>

    <!-- 新增-->
    <insert id="save" parameterType="SetMeal">
        INSERT INTO
        <include refid="tableName"></include>
        (<include refid="Field"></include>)
        VALUES
        (
        #{addUser},
        #{addTime},
        #{updateUser},
        #{updateTime},
        #{cateringTime},
        #{cateringPeriod},
        #{aMenu},
        #{aMenuPrice},
        #{bMenu},
        #{bMenuPrice},
        #{soup},
        #{stewIds},
        #{dessertIds},
        #{isReservation},
        #{isDelete},
        #{carryingType},
        #{photoUrl},
        #{note},
        #{aMenuId},
        #{bMenuId},
    #{id}
        )
    </insert>

    <!--删除-->
    <update id="deleteOne" parameterType="String">
        update <include refid="tableName"></include>
        SET
        is_delete = 1
        where id = #{value}
    </update>

    <!--修改-->
    <update id="updateBySelective" parameterType="SetMeal">
        update
        <include refid="tableName"></include>
        set
        id=#{id}
        <if test="addUser != null">, add_user=#{addUser}</if>
        <if test="addTime != null">, add_time=#{addTime}</if>
        <if test="updateUser != null">, update_user=#{updateUser}</if>
        <if test="updateTime != null">, update_time=#{updateTime}</if>
        <if test="cateringTime != null">, catering_time=#{cateringTime}</if>
        <if test="cateringPeriod != null">, catering_period=#{cateringPeriod}</if>
        <if test="soup != null">, soup=#{soup}</if>
        <if test="stewIds != null">, stew_ids=#{stewIds}</if>
        <if test="dessertIds != null">, dessert_ids=#{dessertIds}</if>
        <if test="isReservation != null">, is_reservation=#{isReservation}</if>
        <if test="carryingType != null">, carrying_type=#{carryingType}</if>
        <if test="photoUrl != null">, photo_url=#{photoUrl}</if>
        <if test="note != null">, note=#{note}</if>
        <if test="aMenuId != null">, a_menu_id=#{aMenuId}</if>
        <if test="bMenuId != null">, b_menu_id=#{bMenuId}</if>
        WHERE
        id=#{id}
    </update>
    <!--通过指定日期修改预约状态-->
    <update id="updateSeservationByDate" parameterType="SetMeal">
        update
        <include refid="tableName"></include>
        set
        is_reservation = #{isReservation}
        WHERE
        is_delete = 0
        AND catering_time= DATE_FORMAT(#{cateringTime},'%Y-%m-%d')
        <choose>
            <when test="isReservation == 1">
                AND is_reservation = 0
            </when>
            <otherwise>
                AND is_reservation = 1
            </otherwise>
        </choose>
    </update>
    <!--条件查询-->
    <select id="selectBySelective" parameterType="SetMeal" resultType="SetMeal">
        select
        sm.add_user,  sm.add_time,  sm.update_user, sm.update_time, sm.catering_time, sm.catering_period,
        sm.stew_ids,  sm.dessert_ids, sm.is_reservation,sm.carrying_type, sm.photo_url,sm.soup,
        sm.note,  sm.a_menu_id, sm.b_menu_id, sm.id, d1.dishes_name AS a_menu,d1.dishes_price AS a_menu_price, d2.dishes_name AS b_menu,d2.dishes_price AS b_menu_price
        from <include refid="tableName"/> AS sm LEFT JOIN t_dishes AS d1 ON d1.id = sm.a_menu_id LEFT JOIN t_dishes AS d2 ON d2.id = sm.b_menu_id
        WHERE sm.is_delete = 0
        <if test="cateringTime != null">AND sm.catering_time = DATE_FORMAT(#{cateringTime},'%Y-%m-%d')</if>
        <if test="cateringPeriod != null">AND sm.catering_period=#{cateringPeriod}</if>
        <if test="aMenu != null and aMenu != '' ">AND (d1.dishes_name LIKE concat('%',#{aMenu},'%') OR d2.dishes_name LIKE concat('%',#{aMenu},'%')   )</if>
        <if test="aMenuPrice != null">AND sm.a_menu_price=#{aMenuPrice}</if>
        <if test="bMenu != null">AND sm.b_menu LIKE concat('%',#{bMenu},'%')</if>
        <if test="bMenuPrice != null">AND sm.b_menu_price=#{bMenuPrice}</if>
        <if test="stewIds != null">AND sm.stew_ids LIKE concat('%',#{stewIds},'%')</if>
        <if test="dessertIds != null">AND sm.dessert_ids LIKE concat('%',#{dessertIds},'%')</if>
        <if test="isReservation != null">AND sm.is_reservation=#{isReservation}</if>
        <if test="carryingType != null">AND sm.carrying_type=#{carryingType}</if>
        <if test="note != null">AND sm.note LIKE concat('%',#{note},'%')</if>
        <if test="note != null">AND sm.note LIKE concat('%',#{note},'%')</if>
        ORDER BY add_time DESC
    </select>

    <!--条件查询-->
    <select id="getSetMealByPage" parameterType="Page" resultMap="BaseResultMap">
        select
        sm.add_user,  sm.add_time,  sm.update_user, sm.update_time, sm.catering_time, sm.catering_period,
        sm.stew_ids,  sm.dessert_ids, sm.is_reservation,sm.carrying_type, sm.photo_url,sm.soup,
        sm.note,  sm.a_menu_id, sm.b_menu_id, sm.id, d1.dishes_name AS a_menu,d1.dishes_price AS a_menu_price, d2.dishes_name AS b_menu,d2.dishes_price AS b_menu_price
        from <include refid="tableName"/> AS sm LEFT JOIN t_dishes AS d1 ON d1.id = sm.a_menu_id LEFT JOIN t_dishes AS d2 ON d2.id = sm.b_menu_id
        WHERE sm.is_delete = 0
        <if test="pd.entity.cateringTime != null">AND sm.catering_time = DATE_FORMAT(#{pd.entity.cateringTime},'%Y-%m-%d')</if>
        <if test="pd.entity.cateringPeriod != null">AND sm.catering_period=#{pd.entity.cateringPeriod}</if>
        <if test="pd.entity.aMenu != null and pd.entity.aMenu != '' ">AND (d1.dishes_name LIKE concat('%',#{pd.entity.aMenu},'%') OR d2.dishes_name LIKE concat('%',#{pd.entity.aMenu},'%')   )</if>
        <if test="pd.entity.aMenuPrice != null">AND sm.a_menu_price=#{pd.entity.aMenuPrice}</if>
        <if test="pd.entity.bMenu != null">AND sm.b_menu LIKE concat('%',#{pd.entity.bMenu},'%')</if>
        <if test="pd.entity.bMenuPrice != null">AND sm.b_menu_price=#{pd.entity.bMenuPrice}</if>
        <if test="pd.entity.stewIds != null">AND sm.stew_ids LIKE concat('%',#{pd.entity.stewIds},'%')</if>
        <if test="pd.entity.dessertIds != null">AND sm.dessert_ids LIKE concat('%',#{pd.entity.dessertIds},'%')</if>
        <if test="pd.entity.isReservation != null">AND sm.is_reservation=#{pd.entity.isReservation}</if>
        <if test="pd.entity.carryingType != null">AND sm.carrying_type=#{pd.entity.carryingType}</if>
        <if test="pd.entity.note != null">AND sm.note LIKE concat('%',#{pd.entity.note},'%')</if>
        <if test="pd.entity.note != null">AND sm.note LIKE concat('%',#{pd.entity.note},'%')</if>
        ORDER BY add_time DESC
    </select>

    <!--批量插入操作-->
    <insert id="saveByList" parameterType="SetMeal">
        INSERT INTO
        <include refid="tableName"></include>
        (<include refid="Field"></include>)
        VALUES
        <foreach item="t" index="index" collection="list" separator=",">
            (
            #{t.addUser},
            #{t.addTime},
            #{t.updateUser},
            #{t.updateTime},
            #{t.cateringTime},
            #{t.cateringPeriod},
            #{t.aMenu},
            #{t.aMenuPrice},
            #{t.bMenu},
            #{t.bMenuPrice},
            #{t.soup},
            #{t.stewIds},
            #{t.dessertIds},
            #{t.isReservation},
            #{t.isDelete},
            #{t.carryingType},
            #{t.photoUrl},
            #{t.note},
            #{t.aMenuId},
            #{t.bMenuId},
            #{t.id}
            )
        </foreach>
    </insert>

    <!--批量删除操作-->
    <update id="deleteArray" parameterType="String">
        update <include refid="tableName"></include>
        SET
        is_delete = 1
        where
        id in
        <foreach item="item" index="index" collection="array" open="(" separator="," close=")">
        #{item}
        </foreach>
    </update>

    <!--查询本周一以后的所有套餐-->
    <select id="getMenuIsAfterMondy" resultType="SetMeal">
        select
        sm.add_user,  sm.add_time,  sm.update_user, sm.update_time, sm.catering_time, sm.catering_period,
        sm.stew_ids,  sm.dessert_ids, sm.is_reservation,sm.carrying_type, sm.photo_url,sm.soup,
        sm.note,  sm.a_menu_id, sm.b_menu_id, sm.id, d1.dishes_name AS a_menu,d1.dishes_price AS a_menu_price, d2.dishes_name AS b_menu,d2.dishes_price AS b_menu_price
        from <include refid="tableName"/> AS sm LEFT JOIN t_dishes AS d1 ON d1.id = sm.a_menu_id LEFT JOIN t_dishes AS d2 ON d2.id = sm.b_menu_id
        WHERE sm.is_delete = 0
        AND <![CDATA[ catering_time >= date_sub(curdate(),INTERVAL WEEKDAY(curdate())  DAY)]]>
        <if test="period != null">
            AND catering_period = #{period}
        </if>
        ORDER BY sm.catering_time
    </select>
</mapper>